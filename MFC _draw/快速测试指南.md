# RAII 功能快速测试指南

## 方法一：自动测试（推荐）

### 步骤：
1. **编译项目**（Debug 模式）
2. **运行应用程序**
3. **打开 Visual Studio 的输出窗口**（视图 -> 输出，或按 Ctrl+Alt+O）
4. **选择"调试"输出**
5. **应用程序启动后会自动运行测试**，测试结果会显示在输出窗口中

### 查看测试结果：
- 在输出窗口中查找以 "=== 测试" 开头的行
- 查看是否有 "✓"（通过）或 "✗"（失败）标记
- 检查 GDI 对象数量变化

---

## 方法二：手动测试

### 2.1 功能测试

#### 测试绘图功能：
1. 运行应用程序
2. 依次测试所有绘图工具：
   - 线段
   - 矩形
   - 圆形
   - 椭圆
   - 铅笔
   - 橡皮擦
   - 文本
3. 验证每个工具都能正常绘制

#### 测试撤销/重做：
1. 绘制几个图形
2. 点击撤销（Ctrl+Z）
3. 点击重做（Ctrl+Y）
4. 验证功能正常

#### 测试文件操作：
1. **打开文件**：文件 -> 打开，选择一个 BMP 图片
2. **保存文件**：文件 -> 保存，保存为不同格式

### 2.2 资源泄漏检测

#### 使用任务管理器：
1. 打开任务管理器（Ctrl+Shift+Esc）
2. 切换到"详细信息"标签
3. 右键点击列标题，选择"选择列"
4. 勾选"GDI 对象"
5. 找到应用程序进程
6. 记录初始 GDI 对象数量
7. 执行大量绘图操作（50-100 次）
8. 观察 GDI 对象数量：
   - **正常**：数量稳定或略有波动（±5）
   - **异常**：数量持续增长（可能存在泄漏）

#### 使用 Process Explorer（更详细）：
1. 下载 Process Explorer（Microsoft Sysinternals）
2. 运行 Process Explorer
3. 找到应用程序进程
4. 查看 "GDI Handles" 列
5. 执行操作并观察变化

### 2.3 异常处理测试

#### 测试无效文件：
1. 尝试打开一个损坏的图片文件
2. 验证是否显示错误消息
3. 验证应用程序不会崩溃

#### 测试边界情况：
1. 绘制非常大的图形
2. 绘制非常小的图形
3. 快速连续绘制多个图形
4. 验证应用程序稳定运行

---

## 方法三：代码审查

### 检查点：

1. **搜索旧代码模式**（应该找不到）：
   ```cpp
   CPen pen;
   pen.CreatePen(...);
   // 没有使用 RAII 包装
   ```

2. **确认使用新代码模式**（应该找到）：
   ```cpp
   CPenWrapper pen(...);
   CGdiObjectSelector<CPen, CPen> selector(...);
   ```

3. **检查异常处理**：
   - 所有 GDI 操作都在 try-catch 块中
   - 有适当的错误处理逻辑

---

## 预期结果

### ✅ 正常情况：
- 所有绘图功能正常工作
- 撤销/重做功能正常
- 文件打开/保存功能正常
- GDI 对象数量稳定
- 没有内存泄漏
- 异常被正确捕获和处理

### ❌ 异常情况（需要修复）：
- 绘图功能异常
- GDI 对象数量持续增长
- 应用程序崩溃
- 异常未被捕获
- 内存使用持续增长

---

## 测试检查清单

- [ ] 编译成功（无错误、无警告）
- [ ] 应用程序正常启动
- [ ] 所有绘图工具正常工作
- [ ] 撤销/重做功能正常
- [ ] 文件打开功能正常
- [ ] 文件保存功能正常
- [ ] GDI 对象数量稳定（资源泄漏测试）
- [ ] 异常处理正常工作
- [ ] 长时间运行无崩溃
- [ ] 输出窗口显示测试通过

---

## 常见问题

### Q: 如何查看测试输出？
A: 在 Visual Studio 中，打开"输出"窗口（视图 -> 输出），选择"调试"输出。

### Q: GDI 对象数量多少算正常？
A: 通常应用程序的 GDI 对象数量在 50-200 之间。执行操作后，数量应该稳定，不应该持续增长。

### Q: 测试没有自动运行？
A: 确保在 Debug 模式下编译和运行。测试代码只在 `#ifdef _DEBUG` 块中。

### Q: 如何手动触发测试？
A: 可以在代码中调用 `RunAllGdiWrapperTests(this)` 函数。

---

## 测试报告模板

```
测试日期：___________
测试人员：___________
测试环境：___________

编译测试：
[ ] 通过  [ ] 失败

功能测试：
[ ] 通过  [ ] 失败

资源泄漏测试：
初始 GDI 对象数：_______
操作后 GDI 对象数：_______
变化量：_______
[ ] 通过  [ ] 失败

异常处理测试：
[ ] 通过  [ ] 失败

总体评价：
[ ] 通过  [ ] 需要修复

备注：
_________________________________
_________________________________
```

